Perfect â€” **Video 4** is where we bring **security and cleanup** to the full login flow. It wraps up the foundational auth system by securing routes, implementing logout, and showing real-world usage of session-based state.

---

## ðŸŽ¬ **Video 4: Auth Guards, Logout, and Securing Routes**

---

### ðŸŽ¯ **Goal:**
By the end of this video, viewers will be able to:
- Secure private routes using custom **auth guards**
- Use `req.user` in any controller
- Add a clean **logout** endpoint
- Understand how session state protects backend resources

---

## ðŸ§± Outline Breakdown

---

### ðŸª§ **1. Intro (1â€“2 min)**

- Recap: We have login, Redis-backed sessions, `req.user`, and `/auth/me`
- This video:
  - Secure routes
  - Handle logout cleanly
  - Show typical backend behavior with session state

---

### ðŸ›¡ï¸ **2. Custom `AuthenticatedGuard` Recap + Refactor (3â€“4 min)**

Already introduced in Video 3 â€” now formalize it.

**`src/auth/guards/authenticated.guard.ts`**
```ts
import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';

@Injectable()
export class AuthenticatedGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const req = context.switchToHttp().getRequest();
    return req.isAuthenticated(); // Passport adds this
  }
}
```

**Register in `AuthModule` or globally if needed.**

---

### ðŸ” **3. Protect Private Routes (4â€“5 min)**

**Example: `@Get('me')` route in `AuthController`**

```ts
@UseGuards(AuthenticatedGuard)
@Get('me')
getProfile(@Request() req) {
  return req.user;
}
```

ðŸ’¡ Bonus: add a `UsersController` with protected routes like `/users`, `/dashboard`, etc.

---

### ðŸ§¼ **4. Clean Logout Flow (3â€“4 min)**

**In `AuthController`:**
```ts
@UseGuards(AuthenticatedGuard)
@Post('logout')
logout(@Request() req) {
  req.logout((err) => {
    if (err) throw new InternalServerErrorException();
  });
  req.session.destroy(() => {});
  return { message: 'Logged out successfully' };
}
```

**Optional check:**
```ts
@Get('status')
status(@Request() req) {
  return { loggedIn: req.isAuthenticated(), user: req.user || null };
}
```

---

### ðŸ”„ **5. Demo the Flow (5â€“6 min)**

Use **Postman, curl, or browser** to show the flow:

1. `POST /auth/login` â†’ returns cookie
2. `GET /auth/me` â†’ returns user
3. `POST /auth/logout` â†’ clears session
4. `GET /auth/me` again â†’ now returns 401 or nothing
5. `GET /auth/status` â†’ check login state

---

### ðŸ”’ **6. Optional: Global Auth Guard (4â€“5 min)**

You can optionally secure **all routes by default**:

**`app.module.ts`:**
```ts
providers: [
  {
    provide: APP_GUARD,
    useClass: AuthenticatedGuard,
  },
],
```

Then allow public routes explicitly using custom `@Public()` decorator and metadata (advanced â€” for another video).

---

### ðŸ§  **7. Final Auth Flow Recap (2â€“3 min)**

Diagram or summary of the entire journey:
- Login â†’ session created â†’ user stored in Redis
- Requests â†’ use cookie â†’ session rehydrated into `req.user`
- Protected routes â†’ `AuthenticatedGuard` enforces auth
- Logout â†’ session destroyed

---

### âœ… **8. Wrap-Up & Whatâ€™s Next (1â€“2 min)**

âœ… You now have:
- Full session-based auth with Redis
- LocalStrategy login
- Route protection
- Logout + session cleanup

ðŸ”œ Next ideas:
- Add **register** flow with validation
- UI app with **Next.js, React, or Postman suite**
- Add roles & permissions, flash messages, remember me, etc.

---

## ðŸ§± File Structure After All 4 Videos

```
src/
â”œâ”€â”€ auth/
â”‚   â”œâ”€â”€ auth.module.ts
â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”œâ”€â”€ guards/
â”‚   â”‚   â””â”€â”€ authenticated.guard.ts
â”‚   â”œâ”€â”€ local.strategy.ts
â”‚   â””â”€â”€ session.serializer.ts
â”œâ”€â”€ users/
â”‚   â”œâ”€â”€ user.entity.ts
â”‚   â”œâ”€â”€ users.module.ts
â”‚   â””â”€â”€ users.service.ts
â”œâ”€â”€ redis/
â”‚   â”œâ”€â”€ redis.module.ts
â”‚   â””â”€â”€ redis.service.ts
main.ts
```

---

Let me know if you'd like:
- ðŸŽž Slide deck for presenting these
- ðŸ§ª Postman collection
- ðŸ“ GitHub template repo
- ðŸ§‘â€ðŸŽ“ Bonus video idea: Signup + form validation with class-validator

Ready to wrap the 4-video series with a short summary or playlist structure?


```javascript

// src/auth/guards/authenticated.guard.ts
import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';

@Injectable()
export class AuthenticatedGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const req = context.switchToHttp().getRequest();
    return req.isAuthenticated();
  }
}

// src/auth/auth.controller.ts
import {
  Controller,
  Post,
  Get,
  UseGuards,
  Request,
  InternalServerErrorException,
} from '@nestjs/common';
import { AuthenticatedGuard } from './guards/authenticated.guard';

@Controller('auth')
export class AuthController {
  @UseGuards(AuthenticatedGuard)
  @Get('me')
  getProfile(@Request() req) {
    return req.user;
  }

  @UseGuards(AuthenticatedGuard)
  @Post('logout')
  logout(@Request() req) {
    req.logout((err) => {
      if (err) {
        throw new InternalServerErrorException();
      }
    });
    req.session.destroy(() => {});
    return { message: 'Logged out successfully' };
  }

  @Get('status')
  status(@Request() req) {
    return {
      loggedIn: req.isAuthenticated(),
      user: req.user || null,
    };
  }
}

// main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import * as session from 'express-session';
import * as passport from 'passport';
import * as connectRedis from 'connect-redis';
import { redisClient } from './redis/redis.service';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  const RedisStore = connectRedis(session);

  app.use(
    session({
      store: new RedisStore({ client: redisClient }),
      secret: 'keyboard cat',
      resave: false,
      saveUninitialized: false,
      cookie: {
        maxAge: 3600000, // 1 hour
        httpOnly: true,
      },
    }),
  );

  app.use(passport.initialize());
  app.use(passport.session());

  await app.listen(3000);
}
bootstrap();

// src/auth/session.serializer.ts
import { PassportSerializer } from '@nestjs/passport';
import { Injectable } from '@nestjs/common';
import { UsersService } from '../users/users.service';
import { User } from '../users/user.entity';

@Injectable()
export class SessionSerializer extends PassportSerializer {
  constructor(private readonly usersService: UsersService) {
    super();
  }

  serializeUser(user: User, done: Function) {
    done(null, user.id);
  }

  async deserializeUser(userId: number, done: Function) {
    const user = await this.usersService.findById(userId);
    if (!user) return done(null, null);
    const { password, ...userWithoutPassword } = user;
    done(null, userWithoutPassword);
  }
}

// Optional: Global Guard Registration (app.module.ts)
import { Module } from '@nestjs/common';
import { APP_GUARD } from '@nestjs/core';
import { AuthenticatedGuard } from './auth/guards/authenticated.guard';

@Module({
  providers: [
    {
      provide: APP_GUARD,
      useClass: AuthenticatedGuard,
    },
  ],
})
export class AppModule {}


```
